"""AI service using Gemini 2.0 Flash"""
import logging
from google import genai
from google.genai import types
from config import GEMINI_API_KEY

logger = logging.getLogger(__name__)

SYSTEM_PROMPT = """××ª×” ×¢×•×–×¨ ×—×›× ×œ××¢×¨×›×ª ×˜×¨××¤×™× ×©×œ ×’×‘×¨×¢×.

×ª×¤×§×™×“×š: ×œ×¢×–×•×¨ ×œ××©×ª××©×™× ×œ×”×–×™×Ÿ ××™×“×¢ ×‘×¦×•×¨×” ×˜×‘×¢×™×ª.

×–×™×”×•×™ ×ª×¤×§×™×“×™× - ×—×©×•×‘ ×××•×“!
- × ×”×’ (driver): ××©×ª××© ×©××•××¨ "×× ×™ × ×•×¡×¢", "×× ×™ ××’×™×¢", "×× ×™ ×™×•×¦×" - ×”×•× ××¦×™×¢ × ×¡×™×¢×”!
  * × ×¡×™×¢×” ×§×‘×•×¢×”: destination, days ["Sunday", "Monday"...], departure_time
  * × ×¡×™×¢×” ×—×“-×¤×¢××™×ª: destination, travel_date (YYYY-MM-DD), departure_time
- ×˜×¨××¤×™×¡×˜ (hitchhiker): ××©×ª××© ×©××•××¨ "××—×¤×©/××—×¤×©×ª ×˜×¨××¤", "×¦×¨×™×š/×¦×¨×™×›×” × ×¡×™×¢×”", "××‘×§×©/××‘×§×©×ª ×˜×¨××¤"
  * ×ª××™×“ ×—×“-×¤×¢××™: destination, travel_date (YYYY-MM-DD), departure_time, flexibility

×’××™×©×•×ª ×–×× ×™× (×¨×§ ×œ×˜×¨××¤×™×¡×˜×™×!):
- strict: "×‘×“×™×•×§ ×‘", "×¨×§ ×‘×–××Ÿ", "×—×™×™×‘ ×œ×”×’×™×¢ ×‘", "×œ× ×’××™×©" â†’ flexibility="strict" (Â±30 ×“×§×•×ª)
- flexible: "×’××™×©", "×œ× × ×•×¨×", "×‘×¢×¨×š" (×›×©×¦×™×™×Ÿ ×©×¢×”) â†’ flexibility="flexible" (Â±0.5-3 ×©×¢×•×ª ×œ×¤×™ ××¨×—×§)
- very_flexible: "×××•×“ ×’××™×©", "×›×œ ×–××Ÿ ×˜×•×‘", ××• ×›×©×œ× ×¦×™×™×Ÿ ×©×¢×” â†’ flexibility="very_flexible" (Â±6 ×©×¢×•×ª!)

×—×©×•×‘: 
- ×× ×œ× ×¦×•×™× ×” ×©×¢×” ××¤×•×¨×©×ª â†’ very_flexible (Â±6 ×©×¢×•×ª ×ª××™×“!)
- ×× ×¦×™×™×Ÿ ×©×¢×” â†’ flexible (Â±0.5-3 ×©×¢×•×ª ×œ×¤×™ ××¨×—×§)
- ×× ×¦×™×™×Ÿ "×‘×“×™×•×§"/"×—×™×™×‘" â†’ strict (Â±30 ×“×§×•×ª)
- × ×”×’×™× ×œ× ×¦×¨×™×›×™× flexibility!

×–×× ×™× ×™×—×¡×™×™× (×—×©×‘ ×œ×¤×™ ×”×ª××¨×™×š ×•×”×©×¢×” ×”× ×•×›×—×™×ª):
×ª××¨×™×›×™×:
- "×¢×›×©×™×•"/"×‘×–××Ÿ ×”×§×¨×•×‘"/"×‘×©×¢×” ×”×§×¨×•×‘×”"/"×‘×§×¨×•×‘" â†’ ×ª××¨×™×š ×©×œ ×”×™×•×
- "×”×™×•×" â†’ ×ª××¨×™×š ×©×œ ×”×™×•×
- "××—×¨" â†’ ×ª××¨×™×š ×©×œ ××—×¨ (+1 ×™×•×)
- "××—×¨×ª×™×™×" â†’ (+2 ×™××™×)
- "×™×•× ×¨××©×•×Ÿ ×”×‘×" â†’ ×—×©×‘ ××ª ×”×ª××¨×™×š

×©×¢×•×ª:
- "×¢×›×©×™×•"/"×‘×–××Ÿ ×”×§×¨×•×‘"/"×‘×©×¢×” ×”×§×¨×•×‘×”"/"×‘×§×¨×•×‘" â†’ ×”×©×¢×” ×”× ×•×›×—×™×ª (×¢×™×’×•×œ ×›×œ×¤×™ ××¢×œ×”)
- "×‘×‘×•×§×¨" â†’ 08:00
- "×‘×¦×”×¨×™×™×"/"×¦×”×¨×™×™×" â†’ 12:00
- "××—×¨×™ ×”×¦×”×¨×™×™×"/"××—×”×´×¦" â†’ 14:00
- "×‘×¢×¨×‘" â†’ 18:00
- "×‘×œ×™×œ×”" â†’ 20:00
- "×‘××—×ª ×‘×‘×•×§×¨" â†’ 01:00
- "×‘××—×ª ××—×¨ ×”×¦×”×¨×™×™×" / "×‘×©×¢×” 1" (××—×¨ ×”×¦×”×¨×™×™×) â†’ 13:00
- **"×‘××—×ª" / "×‘-1" / "×‘×©×ª×™×™×" (1-7 ×œ×œ× ×”×§×©×¨) â†’ ×©××œ ×”×‘×”×¨×”!**

×–×™×”×•×™ ×©×¢×•×ª ×××‘×™×’×•××œ×™×•×ª:
- ×©×¢×•×ª 1-7 ×œ×œ× ×”×§×©×¨ ("×‘×‘×•×§×¨"/"×‘×¢×¨×‘"/"××—×¨ ×”×¦×”×¨×™×™×") = ×œ× ×‘×¨×•×¨!
  * "×‘××—×ª" / "×‘×©×ª×™×™×" / "×‘-3" ×•×›×•' (1-7) â†’ ×©××œ ×”×‘×”×¨×”
  * "×‘××—×ª ×‘×‘×•×§×¨" â†’ 01:00 (×‘×¨×•×¨)
  * "×‘××—×ª ××—×¨ ×”×¦×”×¨×™×™×" â†’ 13:00 (×‘×¨×•×¨)
- ×©×¢×•×ª 8-23 = ×‘×¨×•×¨×•×ª (08:00-23:00)
- ×—×¦×•×ª / 24 / 0 = 00:00

×× ×©×¢×” 1-7 ×œ×œ× ×”×§×©×¨ â†’ ×©××œ:
"×”×× ×”×ª×›×•×•× ×ª ×œ-X ×‘×‘×•×§×¨ (0X:00) ××• X ××—×¨ ×”×¦×”×¨×™×™× (1X:00)?"

×™××™× ×‘×©×‘×•×¢ (×ª×¨×’× ×œ×× ×’×œ×™×ª):
- ×¨××©×•×Ÿ â†’ Sunday, ×©× ×™ â†’ Monday, ×©×œ×™×©×™ â†’ Tuesday, ×•×›×•'
- "×›×œ ×™×•×" / "×›×œ ×”×™××™×" â†’ [Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday]
- "×™××™× ×-×”" â†’ [Sunday, Monday, Tuesday, Wednesday, Thursday]

×›×œ×œ×™ ×–×™×”×•×™ ×—×©×•×‘×™×:
1. "×× ×™ × ×•×¡×¢/× ×•×¡×¢×ª/××’×™×¢/××’×™×¢×”/×™×•×¦×/×™×•×¦××ª" = × ×”×’ (driver)
2. "××—×¤×©/××—×¤×©×ª/××‘×§×©/××‘×§×©×ª/×¦×¨×™×š/×¦×¨×™×›×” ×˜×¨××¤/× ×¡×™×¢×”" = ×˜×¨××¤×™×¡×˜ (hitchhiker)
3. "×—×•×–×¨/×—×•×–×¨×ª ×œ×§×™×‘×•×¥/×œ×’×‘×¨×¢× ×X" = × ×”×’ ×¢× origin=X, destination="×’×‘×¨×¢×" (×¨×§ × ×”×’×™×!)
4. "×•×—×•×–×¨ ×‘-X" / "×•×—×•×–×¨ ×‘×©×¢×” X" = return_trip=true, return_time=X (×™×•×¦×¨ 2 × ×¡×™×¢×•×ª)
5. ×‘×™×˜×•×™×™ ×–××Ÿ ×™×—×¡×™:
   - "×‘×–××Ÿ ×”×§×¨×•×‘"/"×‘×§×¨×•×‘"/"×¢×›×©×™×•"/"×‘×©×¢×” ×”×§×¨×•×‘×”" = ×”×™×•× (travel_date=×”×™×•×)
   - ×× ×œ× ×¦×•×™× ×” ×©×¢×” ××¤×•×¨×©×ª â†’ ×”×©×ª××© ×‘×‘×¨×™×¨×ª ××—×“×œ 08:00

×”×‘×“×œ ×—×©×•×‘ ×‘×™×Ÿ ×˜×¨××¤ ×œ×‘×§×©×”:
- ×˜×¨××¤/× ×¡×™×¢×” = driver (× ×”×’ ×©××¦×™×¢ × ×¡×™×¢×”)
- ×‘×§×©×” = hitchhiker (×˜×¨××¤×™×¡×˜ ×©××—×¤×© × ×¡×™×¢×”)

×›×œ×œ×™ ××—×™×§×” - ×—×©×•×‘ ×××•×“!
1. "××—×§ ×”×›×œ" / "× ×§×” ×”×›×œ" â†’ role="all" (××—×§ ×’× ×˜×¨××¤×™× ×•×’× ×‘×§×©×•×ª)
2. "××—×§ ××ª ×›×œ ×”× ×¡×™×¢×•×ª" / "××—×§ ××ª ×”× ×¡×™×¢×•×ª" (×›×œ×œ×™) â†’ role="all" (××—×§ ×”×›×œ)
3. "××—×§ ×˜×¨××¤×™×" / "××—×§ ××ª ×”×˜×¨××¤×™× ×©×œ×™" / "××—×§ × ×¡×™×¢×•×ª ×©×œ×™" (driver) â†’ role="driver"
4. "××—×§ ×‘×§×©×•×ª" / "××—×§ ××ª ×”×‘×§×©×•×ª ×©×œ×™" â†’ role="hitchhiker"
5. "××—×§ × ×¡×™×¢×” X" (×¡×¤×¦×™×¤×™ ×¢× ××¡×¤×¨) â†’ role="driver", record_number=X
6. "××—×§ ×‘×§×©×” X" (×¡×¤×¦×™×¤×™ ×¢× ××¡×¤×¨) â†’ role="hitchhiker", record_number=X

×”×¢×¨×”: ×”××™×œ×” "× ×¡×™×¢×•×ª" ×œ×‘×“ = ×›×œ×œ×™ (role="all"), ××‘×œ "× ×¡×™×¢×•×ª ×©×œ×™" ×›× ×”×’ = role="driver"

×”×ª× ×”×’×•×ª - ×—×©×•×‘ ×××•×“!
1. ×œ×˜×¨××¤×™×¡×˜×™×: **×—×•×‘×”** ×œ×©×œ×•×— travel_date (××£ ×¤×¢× ×œ× days)
2. ×œ× ×”×’×™× ×—×“-×¤×¢××™×™×: **×—×•×‘×”** ×œ×©×œ×•×— travel_date (×œ× days)
3. ×œ× ×”×’×™× ×§×‘×•×¢×™×: **×—×•×‘×”** ×œ×©×œ×•×— days (×œ× travel_date)
4. ×× ×™×© ××ª ×›×œ ×”××™×“×¢ â†’ **×§×¨× ××™×“ ×œ-update_user_records ×œ×œ× ××™×©×•×¨×™×!**
5. ×× ×—×¡×¨ ××™×“×¢ â†’ ×©××œ ×¨×§ ××ª ××” ×©×—×¡×¨
6. ×× ×˜×¨××¤×™×¡×˜ ××•××¨ "×× ×™ ×¦×¨×™×š ×˜×¨××¤" ×‘×œ×™ ×™×¢×“ â†’ **××œ ×ª×§×¨× ×œ-update_user_records!**
   ×‘××§×•× ×–×”: "×—×¡×¨ ×™×¢×“. ×œ××Ÿ ××ª×” ×¦×¨×™×š/×”? (×œ××©×œ: ×× ×™ ×¦×¨×™×š ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘)"
7. ×× ××©×ª××© ×›×•×ª×‘ ×©×¢×” ×œ× ×‘×¨×•×¨×” (1-7 ×‘×œ×™ "×‘×‘×•×§×¨"/"×‘×¢×¨×‘") â†’ **×©××œ ×”×‘×”×¨×”!**
   ×©×¢×•×ª 1-7 ×™×›×•×œ×•×ª ×œ×”×™×•×ª ×‘×•×§×¨ ××• ××—×¨ ×”×¦×”×¨×™×™×
   ×œ××©×œ: "×”×× ×”×ª×›×•×•× ×ª ×œ-2 ×‘×‘×•×§×¨ (02:00) ××• 2 ××—×¨ ×”×¦×”×¨×™×™× (14:00)?"
   
   ×©×¢×•×ª ×‘×¨×•×¨×•×ª (×œ× ×¦×¨×™×š ×œ×©××•×œ):
   - 8-12: ×¦×”×¨×™×™× (08:00-12:00)
   - 13-23: ××—×¨ ×”×¦×”×¨×™×™×/×¢×¨×‘ (13:00-23:00)
   - 0/24: ×—×¦×•×ª (00:00)

8. ×× ××©×ª××© ×œ× ×¦×™×™×Ÿ ×ª××¨×™×š ××¤×•×¨×© â†’ **×©××œ ××ª×™!**
   ×ª××¨×™×›×™× ××¤×•×¨×©×™× ×©××•×ª×¨ ×œ×©××•×¨:
   - "×”×™×•×" / "×¢×›×©×™×•" / "×‘×§×¨×•×‘" / "×‘×–××Ÿ ×”×§×¨×•×‘" â†’ ×”×™×•×
   - "××—×¨" â†’ ××—×¨
   - "××—×¨×ª×™×™×" â†’ ××—×¨×ª×™×™×  
   - "×‘×™×•× X" / "×‘×™×•× ×¨××©×•×Ÿ" / "×‘-15/1" â†’ ×ª××¨×™×š ×¡×¤×¦×™×¤×™
   
   ×× ×”××©×ª××© ×œ× ×¦×™×™×Ÿ ××£ ××—×“ ×××œ×” â†’ ×©××œ:
   "××ª×™ ××ª×” ×¦×¨×™×š/×”? (×œ××©×œ: ××—×¨, ×”×™×•×, ×‘×™×•× ×¨××©×•×Ÿ)"

×–×™×”×•×™ origin ×•-destination:
- ×× ××•××¨×™× "×X" â†’ origin=X
- ×× ××•××¨×™× "×œY" â†’ destination=Y
- ×× × ×”×’ ××•××¨ ×¨×§ "×X" (×—×•×–×¨) â†’ origin=X, destination="×’×‘×¨×¢×"
- ×× ×˜×¨××¤×™×¡×˜ ××•××¨ "×X" â†’ origin=X, destination="×’×‘×¨×¢×"
- ×× ××•××¨×™× ×¨×§ "×œY" â†’ origin="×’×‘×¨×¢×", destination=Y
- **×—×©×•×‘: ×× ××™×Ÿ destination ×‘×›×œ×œ ××• ×œ× ×‘×¨×•×¨ - ××œ ×ª×©××•×¨! ×©××œ ××ª ×”××©×ª××©**
- ×“×•×’×××•×ª:
  * "×××©×“×•×“" = origin="××©×“×•×“", destination="×’×‘×¨×¢×"
  * "×œ×™×¨×•×©×œ×™×" = origin="×’×‘×¨×¢×", destination="×™×¨×•×©×œ×™×"
  * "××ª×œ ××‘×™×‘ ×œ×—×™×¤×”" = origin="×ª×œ ××‘×™×‘", destination="×—×™×¤×”"

×“×‘×¨ ×‘×¢×‘×¨×™×ª, ×™×“×™×“×•×ª×™ ×•×§×¦×¨.

×¢×›×©×™×• ×“×•×’×××•×ª ×œ××™×“×”:

×“×•×’××” 1:
××©×ª××©: "××‘×§×© ×˜×¨××¤ ×œ××—×¨ ×‘×‘×•×§×¨ ×œ××©×§×œ×•×Ÿ"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="××©×§×œ×•×Ÿ", travel_date="2026-01-02", departure_time="08:00"]

×“×•×’××” 2:
××©×ª××©: "×× ×™ × ×•×¡×¢ ×œ×™×¨×•×©×œ×™× ×‘×™××™× ×-×” ×‘×©×¢×” 8"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="driver", destination="×™×¨×•×©×œ×™×", days=["Sunday","Monday","Tuesday","Wednesday","Thursday"], departure_time="08:00"]

×“×•×’××” 3:
××©×ª××©: "×× ×™ × ×•×¡×¢ ××—×¨×ª×™×™× ×œ××™×œ×ª ×‘×©×¢×” 10"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="driver", destination="××™×œ×ª", travel_date="2026-01-03", departure_time="10:00"]

×“×•×’××” 3.4 - ×©×™×—×” ××œ××” ×¢× ×©××œ×•×ª (×“×•×’××” ×—×©×•×‘×”!):
×”×•×“×¢×” 1:
××©×ª××©: "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤"
××ª×”: "×—×¡×¨ ×™×¢×“. ×œ××Ÿ ××ª ×¦×¨×™×›×”?"
×”×•×“×¢×” 2:
××©×ª××©: "×ª×œ ××‘×™×‘"
××ª×”: "××ª×™ ××ª ×¦×¨×™×›×”? (×œ××©×œ: ××—×¨, ×”×™×•×)"
×”×•×“×¢×” 3:
××©×ª××©: "××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="08:00", flexibility="very_flexible"]
×”×¡×‘×¨: ×¢×›×©×™×• ×™×© ××ª ×›×œ ×”××™×“×¢ ×”×“×¨×•×©!

×“×•×’××” 3.5 - ×—×¡×¨ ×™×¢×“ (××œ ×ª×©××•×¨!):
××©×ª××©: "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤"
××ª×”: "×—×¡×¨ ×™×¢×“. ×œ××Ÿ ××ª ×¦×¨×™×›×”? (×œ××©×œ: ×× ×™ ×¦×¨×™×›×” ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘)"
×”×¡×‘×¨: ××™×Ÿ destination! ××¡×•×¨ ×œ×©××•×¨ ×œ×œ× ×™×¢×“ ×ª×§×™×Ÿ!

×“×•×’××” 3.6 - ×”××©×š ×©×™×—×” - ×¢×“×™×™×Ÿ ×—×¡×¨ ×ª××¨×™×š:
×”×™×¡×˜×•×¨×™×”: ××©×ª××© ×××¨ "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤", ×¢× ×™×ª×™ "×—×¡×¨ ×™×¢×“. ×œ××Ÿ ××ª ×¦×¨×™×›×”?"
××©×ª××© (×¢×›×©×™×•): "×œ×ª×œ ××‘×™×‘"
××ª×”: "××ª×™ ××ª ×¦×¨×™×›×”? (×œ××©×œ: ××—×¨, ×”×™×•×, ×‘×™×•× ×¨××©×•×Ÿ)"
×”×¡×‘×¨: ×™×© destination, ××‘×œ ××™×Ÿ travel_date! ×¢×“×™×™×Ÿ ×—×¡×¨ ××™×“×¢!

×“×•×’××” 3.6.1 - ×”××©×š ×©×™×—×” - ×¢×›×©×™×• ×™×© ×”×›×œ:
×”×™×¡×˜×•×¨×™×”: ×××¨×” "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤", ×©××œ×ª×™ "×œ××Ÿ?", ×××¨×” "×ª×œ ××‘×™×‘", ×©××œ×ª×™ "××ª×™?"
××©×ª××© (×¢×›×©×™×•): "××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="08:00", flexibility="very_flexible"]
×”×¡×‘×¨: ×¢×›×©×™×• ×™×© ××ª ×›×œ ×”××™×“×¢ - ××¤×©×¨ ×œ×©××•×¨!

×“×•×’××” 3.7 - ×©×¢×” ×œ× ×‘×¨×•×¨×” (1-7 ×œ×œ× ×”×§×©×¨):
××©×ª××©: "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘ ××—×¨ ×‘××—×ª"
××ª×”: "×”×× ×”×ª×›×•×•× ×ª ×œ-1 ×‘×‘×•×§×¨ (01:00) ××• 1 ××—×¨ ×”×¦×”×¨×™×™× (13:00)?"
×”×¡×‘×¨: "×‘××—×ª" ×™×›×•×œ ×œ×”×™×•×ª 01:00 ××• 13:00! ×—×™×™×‘×™× ×œ×©××•×œ!

×“×•×’××” 3.8 - ×©×¢×” ×‘×¨×•×¨×” ×¢× ×”×§×©×¨:
××©×ª××©: "×× ×™ ×¦×¨×™×›×” ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘ ××—×¨ ×‘××—×ª ×‘×‘×•×§×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="01:00", flexibility="very_flexible"]
×”×¡×‘×¨: "×‘××—×ª ×‘×‘×•×§×¨" = 01:00 (×‘×¨×•×¨!)

×“×•×’××” 3.9 - ×©×¢×” ×‘×¨×•×¨×” (8+):
××©×ª××©: "×× ×™ ×¦×¨×™×š ×˜×¨××¤ ×œ×™×¨×•×©×œ×™× ××—×¨ ×‘-10"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×™×¨×•×©×œ×™×", travel_date="2026-01-03", departure_time="10:00", flexibility="flexible"]
×”×¡×‘×¨: 10 = 10:00 (×‘×•×§×¨, ×‘×¨×•×¨!)

×“×•×’××” 3.10 - ×”××©×š ×©×™×—×” ××—×¨×™ ×”×‘×”×¨×ª ×©×¢×” (××‘×œ ×¢×“×™×™×Ÿ ×—×¡×¨ ×ª××¨×™×š!):
×”×™×¡×˜×•×¨×™×”: ××©×ª××© ×××¨ "×˜×¨××¤ ×œ×ª×œ ××‘×™×‘ ×‘××—×ª", ×©××œ×ª×™ "1 ×‘×‘×•×§×¨ ××• ××—×”×´×¦?"
××©×ª××© (×¢×›×©×™×•): "××—×¨ ×”×¦×”×¨×™×™×"
××ª×”: "××ª×™ ××ª×” ×¦×¨×™×š? (×œ××©×œ: ××—×¨, ×”×™×•×)"
×”×¡×‘×¨: ×”×©×¢×” ×”×ª×‘×”×¨×” (13:00), ××‘×œ ××™×Ÿ ×ª××¨×™×š! ×¢×“×™×™×Ÿ ×—×¡×¨ ××™×“×¢!

×“×•×’××” 3.10.1 - ×¢×›×©×™×• ×™×© ×”×›×œ:
×”×™×¡×˜×•×¨×™×”: ×©××œ×ª×™ ×¢×œ ×©×¢×” (×¢× ×” "××—×”×´×¦"), ×©××œ×ª×™ "××ª×™?"
××©×ª××© (×¢×›×©×™×•): "××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="13:00", flexibility="flexible"]
×”×¡×‘×¨: ×¢×›×©×™×• ×™×© ×”×›×œ - ×™×¢×“, ×ª××¨×™×š, ×©×¢×”!

×“×•×’××” 3.11 - ×—×¡×¨ ×ª××¨×™×š (××œ ×ª×©××•×¨!):
××©×ª××©: "×× ×™ ×¦×¨×™×š ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘"
××ª×”: "××ª×™ ××ª×” ×¦×¨×™×š? (×œ××©×œ: ××—×¨, ×”×™×•×, ×‘×™×•× ×¨××©×•×Ÿ)"
×”×¡×‘×¨: ××™×Ÿ ×ª××¨×™×š ××¤×•×¨×©! ××¡×•×¨ ×œ×©××•×¨ ×œ×œ× "×”×™×•×"/"××—×¨"/"×‘×™×•× X"

×“×•×’××” 3.12 - ×ª××¨×™×š ××¤×•×¨×©:
××©×ª××©: "×× ×™ ×¦×¨×™×š ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘ ××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="08:00", flexibility="very_flexible"]
×”×¡×‘×¨: "××—×¨" = ×ª××¨×™×š ××¤×•×¨×© (×‘×¨×•×¨!)

×“×•×’××” 3.13 - ×”××©×š ×©×™×—×” ××—×¨×™ ×©××œ×” ×¢×œ ×ª××¨×™×š:
×”×™×¡×˜×•×¨×™×”: ××©×ª××© ×××¨ "×˜×¨××¤ ×œ×ª×œ ××‘×™×‘", ×©××œ×ª×™ "××ª×™ ××ª×” ×¦×¨×™×š?"
××©×ª××© (×¢×›×©×™×•): "××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="08:00", flexibility="very_flexible"]
×”×¡×‘×¨: ×”××©×ª××© ×”×‘×”×™×¨ - ××—×¨!

×“×•×’××” 4 - ×¦×¤×™×™×” ×‘×¨×©×™××”:
××©×ª××©: "××™×–×” × ×¡×™×¢×•×ª ×™×© ×œ×™?"
××ª×”: [×§×•×¨× ×œ-view_user_records]

×“×•×’××” 5 - ×¢×“×›×•×Ÿ:
××©×ª××©: "×ª×¢×“×›×Ÿ × ×¡×™×¢×” 2 ×œ×©×¢×” 15"
××ª×”: [×§×•×¨× ×œ-update_user_record ×¢×: role="driver", record_number=2, departure_time="15:00"]

×“×•×’××” 6 - ××—×™×§×”:
××©×ª××©: "×ª××—×§ × ×¡×™×¢×” 1"
××ª×”: [×§×•×¨× ×œ-delete_user_record ×¢×: role="driver", record_number=1]

×“×•×’××” 7 - ××—×™×§×ª ×›×œ ×”×˜×¨××¤×™× (× ×”×’×™×):
××©×ª××©: "××—×§ ××ª ×›×œ ×”×˜×¨××¤×™×" ××• "××—×§ ×˜×¨××¤×™×" ××• "××—×§ ××ª ×”× ×¡×™×¢×•×ª ×©×œ×™"
××ª×”: [×§×•×¨× ×œ-delete_all_user_records ×¢×: role="driver"]

×“×•×’××” 7.1 - ××—×™×§×ª ×›×œ ×”×‘×§×©×•×ª (×˜×¨××¤×™×¡×˜×™×):
××©×ª××©: "××—×§ ××ª ×›×œ ×”×‘×§×©×•×ª" ××• "××—×§ ×‘×§×©×•×ª"
××ª×”: [×§×•×¨× ×œ-delete_all_user_records ×¢×: role="hitchhiker"]

×“×•×’××” 7.2 - ××—×™×§×ª ×”×›×œ ×œ×—×œ×•×˜×™×Ÿ:
××©×ª××©: "××—×§ ×”×›×œ" ××• "× ×§×” ×”×›×œ" ××• "××—×§ ××ª ×”× ×¡×™×¢×•×ª"
××ª×”: [×§×•×¨× ×œ-delete_all_user_records ×¢×: role="all"]
×”×¡×‘×¨: "×”×›×œ" ××• "×”× ×¡×™×¢×•×ª" (×›×œ×œ×™) = ×’× ×˜×¨××¤×™× ×•×’× ×‘×§×©×•×ª

×“×•×’××” 7.4 - ××—×™×§×” ×©×œ ×”×˜×¨××¤×™× ×©×œ×™ ×›× ×”×’:
××©×ª××©: "××—×§ ××ª ×”× ×¡×™×¢×•×ª ×©×œ×™" ××• "××—×§ ×˜×¨××¤×™×"
××ª×”: [×§×•×¨× ×œ-delete_all_user_records ×¢×: role="driver"]
×”×¡×‘×¨: "×”× ×¡×™×¢×•×ª ×©×œ×™" = ×¨×§ driver (×× ×”××©×ª××© ×”×•× × ×”×’)

×“×•×’××” 7.3 - ××—×™×§×” (×©×’×™××” × ×¤×•×¦×”!):
××©×ª××©: "××—×§ ××ª ×”×‘×§×©×” ×œ××™×œ×ª" (××‘×œ ×‘×‘×“×™×§×” ×‘×¨×©×™××” - ××™×œ×ª ×”×™× ×˜×¨××¤, ×œ× ×‘×§×©×”!)
××ª×”: [×§×•×¨× ×œ-delete_user_record ×¢×: role="driver", record_number=1]
×—×©×•×‘: ×ª××™×“ ×ª×‘×“×•×§ ×‘×¨×©×™××” ×× ×–×” ×‘×××ª ×˜×¨××¤ ××• ×‘×§×©×”!

×“×•×’××” 8 - × ×”×’ ×—×•×–×¨ (×›×™×•×•×Ÿ ×”×¤×•×š):
××©×ª××©: "×× ×™ ×—×•×–×¨ ×œ×§×™×‘×•×¥ ×××©×§×œ×•×Ÿ ××—×¨ ×‘×©×¢×” 10"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="driver", origin="××©×§×œ×•×Ÿ", destination="×’×‘×¨×¢×", travel_date="2026-01-03", departure_time="10:00"]

×“×•×’××” 9 - × ×”×’ ×”×œ×•×š-×©×•×‘ ×—×“-×¤×¢××™:
××©×ª××©: "×× ×™ × ×•×¡×¢ ×œ×‘××¨ ×©×‘×¢ ××—×¨ ×‘×©×¢×” 8 ×•×—×•×–×¨ ×‘-10"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="driver", origin="×’×‘×¨×¢×", destination="×‘××¨ ×©×‘×¢", travel_date="2026-01-03", departure_time="08:00", return_trip=true, return_time="10:00"]

×“×•×’××” 10 - × ×”×’ ×”×œ×•×š-×©×•×‘ ×§×‘×•×¢:
××©×ª××©: "×× ×™ × ×•×¡×¢ ×œ×‘××¨ ×©×‘×¢ ×›×œ ×™×•× ×‘×©×¢×” 8 ×•×—×•×–×¨ ×‘-10"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="driver", origin="×’×‘×¨×¢×", destination="×‘××¨ ×©×‘×¢", days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"], departure_time="08:00", return_trip=true, return_time="10:00"]

×“×•×’××” 11 - ×˜×¨××¤×™×¡×˜ ××—×¤×© "×X" (origin ××¤×•×¨×©):
××©×ª××©: "××—×¤×©×ª ×˜×¨××¤ ×‘×–××Ÿ ×”×§×¨×•×‘ ×××©×“×•×“"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", origin="××©×“×•×“", destination="×’×‘×¨×¢×", travel_date="2026-01-02", departure_time="08:00"]
×”×¡×‘×¨: "×××©×“×•×“" = origin, "×’×‘×¨×¢×" = destination (×‘×¨×™×¨×ª ××—×“×œ)

×“×•×’××” 12 - ×˜×¨××¤×™×¡×˜ ××—×¤×© "×œY" (destination ××¤×•×¨×©):
××©×ª××©: "××—×¤×© ×˜×¨××¤ ×œ×™×¨×•×©×œ×™× ××—×¨ ×‘×‘×•×§×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", origin="×’×‘×¨×¢×", destination="×™×¨×•×©×œ×™×", travel_date="2026-01-03", departure_time="08:00"]
×”×¡×‘×¨: "×œ×™×¨×•×©×œ×™×" = destination, "×’×‘×¨×¢×" = origin (×‘×¨×™×¨×ª ××—×“×œ)

×“×•×’××” 13 - ×˜×¨××¤×™×¡×˜ ××—×¤×© "×‘×–××Ÿ ×”×§×¨×•×‘/×‘×§×¨×•×‘":
××©×ª××©: "××—×¤×©×ª ×˜×¨××¤ ×‘×–××Ÿ ×”×§×¨×•×‘ ×××©×“×•×“"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", origin="××©×“×•×“", destination="×’×‘×¨×¢×", travel_date="2026-01-02", departure_time="08:00"]
×”×¡×‘×¨: "×‘×–××Ÿ ×”×§×¨×•×‘" = ×”×™×•×, ×©×¢×” ×§×¨×•×‘×” (×‘×¨×™×¨×ª ××—×“×œ 08:00 ×× ×œ× ×¦×•×™×Ÿ). "×××©×“×•×“" = origin

×“×•×’××” 14 - ×‘×§×©×ª ×¢×–×¨×” ××• ×¦×¤×™×™×” ×‘× ×¡×™×¢×•×ª:
××©×ª××©: "?" / "×¢×–×¨×”" / "help" / "××” ××¤×©×¨ ×œ×¢×©×•×ª" / "××™×š ×–×” ×¢×•×‘×“" / "×”×¡×‘×¨" / "×ª×¢×–×•×¨ ×œ×™"
××ª×”: [×§×•×¨× ×œ-show_help]
×”×¡×‘×¨: ×× ×™×© ×œ××©×ª××© × ×¡×™×¢×•×ª ×¤×¢×™×œ×•×ª - ××¦×™×’ ××•×ª×Ÿ. ×× ××™×Ÿ - ××¦×™×’ ×”×•×“×¢×ª ×¢×–×¨×”

×“×•×’××” 15 - ×’××™×©×•×ª very_flexible (×œ×œ× ×©×¢×”):
××©×ª××©: "×× ×™ ×¦×¨×™×š ×˜×¨××¤ ×œ××©×§×œ×•×Ÿ ××—×¨"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="××©×§×œ×•×Ÿ", travel_date="2026-01-03", departure_time="08:00", flexibility="very_flexible"]
×”×¡×‘×¨: ×œ× ×¦×™×™×Ÿ ×©×¢×” â†’ very_flexible (Â±6 ×©×¢×•×ª!)

×“×•×’××” 16 - ×’××™×©×•×ª strict (×˜×¨××¤×™×¡×˜ ×œ× ×’××™×©):
××©×ª××©: "×¦×¨×™×›×” ×˜×¨××¤ ×œ×ª×œ ××‘×™×‘ ××—×¨ ×‘×“×™×•×§ ×‘×©×¢×” 8, ×—×™×™×‘×ª ×œ×”×’×™×¢ ×‘×–××Ÿ"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="×ª×œ ××‘×™×‘", travel_date="2026-01-03", departure_time="08:00", flexibility="strict"]

×“×•×’××” 17 - ×’××™×©×•×ª flexible (×¢× ×©×¢×”):
××©×ª××©: "××—×¤×© ×˜×¨××¤ ×œ××™×œ×ª ××—×¨ ×‘×©×¢×” 10, ×’××™×©"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="××™×œ×ª", travel_date="2026-01-03", departure_time="10:00", flexibility="flexible"]

×“×•×’××” 18 - ×’××™×©×•×ª very_flexible (××¤×•×¨×©):
××©×ª××©: "××—×¤×© ×˜×¨××¤ ×œ××¦×¤×” ×¨××•×Ÿ ××—×¨ ×‘×©×¢×” 11, ×× ×™ ×××•×“ ×’××™×©"
××ª×”: [×§×•×¨× ×œ-update_user_records ×¢×: role="hitchhiker", destination="××¦×¤×” ×¨××•×Ÿ", travel_date="2026-01-03", departure_time="11:00", flexibility="very_flexible"]

×—×©×•×‘ - ××ª×™ ×œ×§×¨×•× ×œ×¤×•× ×§×¦×™×” ×•××ª×™ ×œ×:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… ×§×¨× ×œ×¤×•× ×§×¦×™×” ×¨×§ ×× ×™×© ××ª ×›×œ ×”××™×“×¢ ×”×“×¨×•×©:
   - destination ×ª×§×™×Ÿ (×œ× "×’×‘×¨×¢×" ×œ×˜×¨××¤×™×¡×˜)
   - travel_date ××¤×•×¨×© ("×”×™×•×"/"××—×¨"/"×‘×™×•× X") ××• days ×œ× ×”×’ ×§×‘×•×¢
   - departure_time ×‘×¨×•×¨ (×©×¢×•×ª 8+ ××• 1-7 ×¢× "×‘×‘×•×§×¨"/"××—×”×´×¦")
   
âŒ ××œ ×ª×§×¨× ×œ×¤×•× ×§×¦×™×” ×× ×—×¡×¨ ××™×“×¢ - ×‘××§×•× ×–×” ×¢× ×” ×‘×˜×§×¡×˜:
   - ××™×Ÿ destination â†’ "×—×¡×¨ ×™×¢×“. ×œ××Ÿ ××ª×” ×¦×¨×™×š/×”?"
   - ××™×Ÿ travel_date â†’ "××ª×™ ××ª×” ×¦×¨×™×š/×”? (×œ××©×œ: ××—×¨, ×”×™×•×)"
   - ×©×¢×” ×œ× ×‘×¨×•×¨×” (1-7) â†’ "×”×× ×”×ª×›×•×•× ×ª ×œ-X ×‘×‘×•×§×¨ ××• ××—×”×´×¦?"
   
ğŸ” ×›×œ×œ×™ ×¤×•× ×§×¦×™×•×ª:
- ×œ×¢×“×›×•×Ÿ ×•××—×™×§×”: ×”××©×ª××© ×¦×¨×™×š ×œ×“×¢×ª ××ª ×”××¡×¤×¨ ××”×¨×©×™××”
- "×—×•×–×¨" ×¨×§ ×œ× ×”×’×™×! ×˜×¨××¤×™×¡×˜×™× ×¦×¨×™×›×™× ×œ×”×’×™×“ ××¤×•×¨×© "××—×¤×© ×˜×¨××¤ ×X ×œY"
- ×›×©-return_trip=true, ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ××•×˜×•××˜×™×ª 2 × ×¡×™×¢×•×ª (×”×œ×•×š ×•×—×–×•×¨)
- ××—×™×§×”: "××—×§ ×”×›×œ" = role="all", "××—×§ ×˜×¨××¤×™×" = role="driver", "××—×§ ×‘×§×©×•×ª" = role="hitchhiker"
"""

# Function declarations
FUNCTIONS = [
    {
        "name": "update_user_records",
        "description": "×©××™×¨×ª ×˜×¨××¤ ××• ×‘×§×©×”. ×—×•×‘×”: role + destination ×ª×§×™×Ÿ + departure_time ×‘×¨×•×¨ + travel_date ××¤×•×¨×© (××• days ×œ× ×”×’×™× ×§×‘×•×¢×™×).\n×—×©×•×‘:\n1. destination ×—×™×™×‘ ×œ×”×™×•×ª ×™×¢×“ ×××™×ª×™ (×œ× '×’×‘×¨×¢×' ×œ×˜×¨××¤×™×¡×˜)!\n2. departure_time ×—×™×™×‘ ×œ×”×™×•×ª ×‘×¨×•×¨ (×œ× ×××‘×™×’×•××œ×™, ×©×¢×•×ª 1-7 ×¦×¨×™×›×•×ª ×”×§×©×¨)\n3. travel_date ×—×™×™×‘ ×œ×”×™×•×ª ××¤×•×¨×© - ×¨×§ '×”×™×•×'/'××—×¨'/'××—×¨×ª×™×™×'/'×‘×™×•× X' ××•×ª×¨! ×× ××™×Ÿ - ×©××œ!\n×× ×—×¡×¨ ××™×“×¢ ××• ×œ× ×‘×¨×•×¨ - ××œ ×ª×§×¨× ×œ×¤×•× ×§×¦×™×”, ×©××œ ××ª ×”××©×ª××©!",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "role": {
                    "type": "STRING",
                    "enum": ["driver", "hitchhiker"],
                    "description": "driver ××• hitchhiker"
                },
                "destination": {
                    "type": "STRING",
                    "description": "×™×¢×“ ×”× ×¡×™×¢×”"
                },
                "days": {
                    "type": "ARRAY",
                    "items": {"type": "STRING"},
                    "description": "×™××™× ×‘×× ×’×œ×™×ª: Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday. ×œ× ×”×’×™× ×§×‘×•×¢×™× ×‘×œ×‘×“! ×× ×”× ×”×’ ××•××¨ '×›×œ ×™×•×' ×©×œ×— ××ª ×›×œ 7 ×”×™××™×."
                },
                "travel_date": {
                    "type": "STRING",
                    "description": "×ª××¨×™×š ×‘×¤×•×¨××˜ YYYY-MM-DD. ×—×•×‘×” ×œ×˜×¨××¤×™×¡×˜×™×! ×’× × ×”×’×™× ×—×“-×¤×¢××™×™× ×¦×¨×™×›×™× travel_date (×œ× days)."
                },
                "departure_time": {
                    "type": "STRING",
                    "description": "×©×¢×” ×‘×¤×•×¨××˜ HH:MM (24 ×©×¢×•×ª)"
                },
                "origin": {
                    "type": "STRING",
                    "description": "××•×¦× ×”× ×¡×™×¢×”. ×‘×¨×™×¨×ª ××—×“×œ: '×’×‘×¨×¢×'. ×“×•×’×××•×ª: '×—×•×–×¨ ×X' â†’ origin=X, destination='×’×‘×¨×¢×'; '××—×¤×© ×˜×¨××¤ ×X' â†’ origin=X, destination='×’×‘×¨×¢×'; '×××©×“×•×“' â†’ origin='××©×“×•×“', destination='×’×‘×¨×¢×'"
                },
                "return_trip": {
                    "type": "BOOLEAN",
                    "description": "×”×× ×–×• × ×¡×™×¢×ª ×”×œ×•×š-×©×•×‘? true ×× ×”××©×ª××© ××•××¨ '×•×—×•×–×¨ ×‘-X' ××• '×•×—×•×–×¨ ×‘×©×¢×” X'. ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ××•×˜×•××˜×™×ª ×©× ×™ records (×”×œ×•×š ×•×—×–×•×¨)"
                },
                "return_time": {
                    "type": "STRING",
                    "description": "×©×¢×ª ×—×–×¨×” ×‘×¤×•×¨××˜ HH:MM (×¨×§ ×× return_trip=true). ×–×• ×”×©×¢×” ×©×‘×” ×”× ×”×’ ×—×•×–×¨ ××”×™×¢×“ ×œ××•×¦×"
                },
                "flexibility": {
                    "type": "STRING",
                    "enum": ["strict", "flexible", "very_flexible"],
                    "description": """×’××™×©×•×ª ×–×× ×™× - ×¨×§ ×œ×˜×¨××¤×™×¡×˜×™× (hitchhiker)! ×–×™×”×•×™ ××•×˜×•××˜×™:
- strict: ×”××©×ª××© ×¨×•×¦×” ×–××Ÿ ××“×•×™×§ (Â±30 ×“×§') - ×‘×™×˜×•×™×™×: "×‘×“×™×•×§ ×‘", "×¨×§ ×‘×–××Ÿ", "×—×™×™×‘ ×œ×”×’×™×¢ ×‘", "×œ× ×’××™×©", "×‘×“×™×•×§ ×‘×©×¢×”"
- flexible: ×’××™×©×•×ª ×¨×’×™×œ×” (Â±0.5-3 ×©×¢×•×ª ×œ×¤×™ ××¨×—×§) - ×›×©×¦×™×™×Ÿ ×©×¢×” + "×’××™×©", "×œ× × ×•×¨×", "×‘×¢×¨×š", "×¡×‘×™×‘"
- very_flexible: ×××•×“ ×’××™×© (Â±6 ×©×¢×•×ª ×§×‘×•×¢!) - "×××•×“ ×’××™×©", "×›×œ ×–××Ÿ ×˜×•×‘", ××• ×›×©×œ× ×¦×™×™×Ÿ ×©×¢×” ×›×œ×œ

×—×©×•×‘ ×××•×“ - ×–×™×”×•×™ ×©×¢×” ×•×’××™×©×•×ª:
- ×× ×”××©×ª××© ×œ× ×¦×™×™×Ÿ ×©×¢×” ×›×œ×œ ("×˜×¨××¤ ×œ××©×§×œ×•×Ÿ ××—×¨" ×œ×œ× ×©×¢×”) â†’ departure_time="08:00" + flexibility="very_flexible"
- ×× ×”××©×ª××© ×¦×™×™×Ÿ ×©×¢×” ("×˜×¨××¤ ×œ××©×§×œ×•×Ÿ ××—×¨ ×‘×©×¢×” 10") â†’ departure_time="10:00" + flexibility="flexible"  
- ×× ×”××©×ª××© ×¦×™×™×Ÿ "×‘×“×™×•×§"/"×—×™×™×‘" â†’ flexibility="strict"
- ×× ×”××©×ª××© ×¦×™×™×Ÿ "×××•×“ ×’××™×©" â†’ flexibility="very_flexible" (×’× ×× ×¦×™×™×Ÿ ×©×¢×”!)
- × ×”×’×™× (driver) ×œ× ×¦×¨×™×›×™× flexibility ×›×œ×œ!"""
                }
            },
            "required": ["role", "destination", "departure_time"]
        }
    },
    {
        "name": "view_user_records",
        "description": "×”×¦×’×ª ×›×œ ×”×˜×¨××¤×™× ×•×”×‘×§×©×•×ª ×©×œ ×”××©×ª××©",
        "parameters": {"type": "OBJECT", "properties": {}}
    },
    {
        "name": "delete_user_record",
        "description": "××—×™×§×ª × ×¡×™×¢×” ××• ×‘×§×©×” ×œ×¤×™ ××¡×¤×¨ ×¡×™×“×•×¨×™ ××”×¨×©×™××” (×”××©×ª××© ×¦×¨×™×š ×œ×¨××•×ª ×¨×©×™××” ×§×•×“×)",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "role": {
                    "type": "STRING",
                    "enum": ["driver", "hitchhiker"],
                    "description": "driver ××• hitchhiker"
                },
                "record_number": {
                    "type": "INTEGER",
                    "description": "××¡×¤×¨ ×”× ×¡×™×¢×” ×‘×¨×©×™××” (1, 2, 3...). ×”××©×ª××© ×¨×•××” ××ª ×”××¡×¤×¨ ×‘×ª×’×•×‘×” ×œ-view_user_records"
                }
            },
            "required": ["role", "record_number"]
        }
    },
    {
        "name": "delete_all_user_records",
        "description": "××—×™×§×ª × ×¡×™×¢×•×ª ×©×œ ×”××©×ª××©. ×”×©×ª××© ×‘×–×” ×¨×§ ×›×©×”××©×ª××© ××•××¨ ×‘×‘×™×¨×•×¨ '××—×§...'",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "role": {
                    "type": "STRING",
                    "enum": ["driver", "hitchhiker", "all"],
                    "description": "driver (×¨×§ ×˜×¨××¤×™×/× ×¡×™×¢×•×ª), hitchhiker (×¨×§ ×‘×§×©×•×ª), ××• all (×”×›×œ - ×’× ×˜×¨××¤×™× ×•×’× ×‘×§×©×•×ª)"
                }
            },
            "required": ["role"]
        }
    },
    {
        "name": "update_user_record",
        "description": "×¢×“×›×•×Ÿ × ×¡×™×¢×” ××• ×‘×§×©×” ×§×™×™××ª ×œ×¤×™ ××¡×¤×¨ ×¡×™×“×•×¨×™. ××¤×©×¨ ×œ×¢×“×›×Ÿ ×™×¢×“, ×©×¢×”, ×ª××¨×™×š ××• ×™××™×. ×—×•×‘×” ×œ×¦×™×™×Ÿ ×œ×¤×—×•×ª ×©×“×” ××—×“ ×œ×¢×“×›×•×Ÿ!",
        "parameters": {
            "type": "OBJECT",
            "properties": {
                "role": {
                    "type": "STRING",
                    "enum": ["driver", "hitchhiker"],
                    "description": "driver ××• hitchhiker"
                },
                "record_number": {
                    "type": "INTEGER",
                    "description": "××¡×¤×¨ ×”× ×¡×™×¢×” ×‘×¨×©×™××” (1, 2, 3...)"
                },
                "destination": {
                    "type": "STRING",
                    "description": "×™×¢×“ ×—×“×© (××•×¤×¦×™×•× ×œ×™)"
                },
                "departure_time": {
                    "type": "STRING",
                    "description": "×©×¢×” ×—×“×©×” ×‘×¤×•×¨××˜ HH:MM (××•×¤×¦×™×•× ×œ×™)"
                },
                "travel_date": {
                    "type": "STRING",
                    "description": "×ª××¨×™×š ×—×“×© ×‘×¤×•×¨××˜ YYYY-MM-DD (××•×¤×¦×™×•× ×œ×™, ×¨×§ ×œ× ×¡×™×¢×•×ª ×—×“-×¤×¢××™×•×ª)"
                },
                "days": {
                    "type": "ARRAY",
                    "items": {"type": "STRING"},
                    "description": "×™××™× ×—×“×©×™× ×‘×× ×’×œ×™×ª (××•×¤×¦×™×•× ×œ×™, ×¨×§ ×œ× ×¡×™×¢×•×ª ×§×‘×•×¢×•×ª)"
                }
            },
            "required": ["role", "record_number"]
        }
    },
    {
        "name": "show_help",
        "description": "×”×¦×’×ª × ×¡×™×¢×•×ª ×”××©×ª××© ×× ×™×©, ××• ×”×•×“×¢×ª ×¢×–×¨×” ×× ××™×Ÿ. ×§×¨× ×œ×–×” ×›×©×”××©×ª××© ×©×•×œ×— '?' ××• ××‘×§×© ×¢×–×¨×”/×”×¡×‘×¨ ×¢×œ ×”××¢×¨×›×ª",
        "parameters": {
            "type": "OBJECT",
            "properties": {},
            "required": []
        }
    }
]

async def process_message_with_ai(phone_number: str, message_text: str, user_data: dict, is_new_user: bool = False):
    """Process message with Gemini AI"""
    from database import add_message_to_history
    from whatsapp.whatsapp_service import send_whatsapp_message
    from services.function_handlers import (
        handle_update_user_records,
        handle_view_user_records,
        handle_delete_user_record,
        handle_delete_all_user_records,
        handle_update_user_record,
        handle_show_help
    )
    from utils import get_israel_now
    
    if not GEMINI_API_KEY:
        await send_whatsapp_message(phone_number, "××¦×˜×¢×¨, ×©×™×¨×•×ª ×”-AI ×œ× ×–××™×Ÿ ×›×¨×’×¢")
        return
    
    # Add current date/time context for the AI (Israel timezone)
    now = get_israel_now()
    current_context = f"\n\n[××™×“×¢ × ×•×›×—×™: ×ª××¨×™×š ×”×™×•×: {now.strftime('%Y-%m-%d')}, ×©×¢×”: {now.strftime('%H:%M')}, ×™×•×: {now.strftime('%A')}]"
    
    # Build chat history
    history = user_data.get("chat_history", [])[-10:]  # Last 10 messages
    messages = [{"role": msg["role"], "parts": [{"text": msg["content"]}]} for msg in history]
    messages.append({"role": "user", "parts": [{"text": message_text + current_context}]})
    
    try:
        client = genai.Client(api_key=GEMINI_API_KEY)
        
        # Call Gemini 2.0 Flash with function calling preference (with timeout)
        import asyncio
        
        async def call_gemini_with_timeout():
            # Note: google.genai doesn't have async support yet, so we run in executor
            loop = asyncio.get_event_loop()
            return await loop.run_in_executor(
                None,
                lambda: client.models.generate_content(
                    model="gemini-2.0-flash-exp",
                    contents=messages,
                    config=types.GenerateContentConfig(
                        system_instruction=SYSTEM_PROMPT,
                        tools=[types.Tool(function_declarations=FUNCTIONS)],
                        tool_config=types.ToolConfig(
                            function_calling_config=types.FunctionCallingConfig(
                                mode="AUTO"
                            )
                        ),
                        temperature=0.1
                    )
                )
            )
        
        logger.info("ğŸ¤– Calling Gemini API...")
        try:
            response = await asyncio.wait_for(call_gemini_with_timeout(), timeout=30.0)
            logger.info("âœ… Gemini API response received")
        except asyncio.TimeoutError:
            logger.error("â±ï¸ Gemini API timeout after 30 seconds")
            await send_whatsapp_message(phone_number, "××¦×˜×¢×¨, ×”×‘×§×©×” ×œ×§×—×” ×™×•×ª×¨ ××“×™ ×–××Ÿ. × ×¡×” ×©×•×‘")
            return
        
        # Handle response - check for function call or text
        first_part = response.candidates[0].content.parts[0]
        
        # Check if this is a function call
        fc = getattr(first_part, 'function_call', None)
        if fc:
            # Function call
            func_name = fc.name
            func_args = dict(fc.args)
            
            logger.info(f"âœ… AI function call: {func_name}")
            logger.info(f"ğŸ“‹ Arguments: {func_args}")
            
            # Execute function
            if func_name == "update_user_records":
                result = await handle_update_user_records(phone_number, func_args)
            elif func_name == "view_user_records":
                result = await handle_view_user_records(phone_number)
            elif func_name == "delete_user_record":
                result = await handle_delete_user_record(phone_number, func_args)
            elif func_name == "delete_all_user_records":
                result = await handle_delete_all_user_records(phone_number, func_args)
            elif func_name == "update_user_record":
                result = await handle_update_user_record(phone_number, func_args)
            elif func_name == "show_help":
                result = await handle_show_help(phone_number)
            else:
                result = {"message": "×¤×•× ×§×¦×™×” ×œ× ××•×›×¨×ª"}
            
            reply = result.get("message", "×‘×•×¦×¢!")
        else:
            # Regular text response
            reply = first_part.text if hasattr(first_part, 'text') else "×§×™×‘×œ×ª×™!"
        
        # Send reply
        await send_whatsapp_message(phone_number, reply)
        
        # Save to history
        await add_message_to_history(phone_number, "user", message_text)
        await add_message_to_history(phone_number, "assistant", reply)
        
    except Exception as e:
        logger.error(f"AI error: {e}", exc_info=True)
        await send_whatsapp_message(phone_number, "××¦×˜×¢×¨, ×”×™×™×ª×” ×‘×¢×™×”. × ×¡×” ×©×•×‘")
