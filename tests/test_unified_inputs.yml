# Unified Test Scenarios for Hiker WhatsApp Bot
# Combines integration tests, time range tests, and conversation flow tests
# Supports multiple users, frozen time, notifications, HTML reports, and logs
#
# Message format options:
# 1. Simple string: "היי" (uses scenario's frozen_time or current time)
# 2. Dict with frozen_time:
#    - message: "היי"
#      frozen_time: "2025-11-22 07:15:00"  # Override time for this specific message
#
# The frozen_time can be in ISO format (2025-11-22T07:15:00) or simple format (2025-11-22 07:15:00)
#
# Scenario fields:
# - id: Unique scenario ID
# - name: Scenario name
# - description: Scenario description
# - frozen_time: Optional frozen time for the entire scenario (if not specified, uses real time)
# - should_match: Optional boolean indicating if matches should be found
# - expected_matches: Optional number of expected matches
# - users: List of user actions

scenarios:
  # ============================================================================
  # BASIC INTEGRATION SCENARIOS (No frozen time)
  # ============================================================================
  
  # Scenario 1: Basic matching flow - driver creates routine, hitchhiker requests ride
  - id: 1
    name: "Basic Matching Flow - Morning Routine"
    description: "Driver sets morning routine to Tel Aviv, hitchhiker requests ride to same destination, matching occurs"
    frozen_time: "2025-11-22 07:15:00"  # Set time to morning to match routine
    should_match: true
    expected_matches: 1
    users:
      - user_id: "driver_001"
        phone: "0501111111"
        type: "driver"
        setup_messages:
          - "היי"
          - "יוסי נהג"
          - "חיפה"
          - "2"  # Driver
          - "1"  # Has routine
          - "תל אביב"
          - "כל יום"  # All days
          - "07:00"  # Departure time
          - "18:00"  # Return time
          - "2"  # No more destinations
          - "3"  # Alert preference
          - "1"  # Share name preference: always
        wait_after: 0
        
      - user_id: "hitchhiker_001"
        phone: "0502222222"
        type: "hitchhiker"
        setup_messages:
          - "שלום"
          - "דני טרמפיסט"
          - "תל אביב"
          - "1"  # Hitchhiker
          - "2"  # Not looking now
          - "2"  # No default destination
        wait_after: 0
        
      - user_id: "hitchhiker_001"
        phone: "0502222222"
        type: "hitchhiker"
        action_messages:
          - "שלום"  # Trigger menu
          - "1"  # Looking for ride
          - "1"  # Now (ממש עכשיו)
          - "תל אביב"  # Destination
        wait_after: 0
        
      - user_id: "driver_001"
        phone: "0501111111"
        type: "driver"
        action_messages:
          - "1"  # Approve match
        wait_after: 0

  # Scenario 2: Multiple drivers, one hitchhiker
  - id: 2
    name: "Multiple Drivers Matching"
    description: "Two drivers with same destination, hitchhiker requests ride, both get matched"
    frozen_time: "2025-11-22 08:15:00"  # Set time to morning to match routines
    should_match: true
    expected_matches: 2
    users:
      - user_id: "driver_002a"
        phone: "0503333333"
        type: "driver"
        setup_messages:
          - "היי"
          - "אבי נהג"
          - "חיפה"
          - "2"  # Driver
          - "1"
          - "ירושלים"
          - "כל יום"
          - "08:00"
          - "17:00"
          - "2"
          - "3"
          - "1"
        wait_after: 0
        
      - user_id: "driver_002b"
        phone: "0504444444"
        type: "driver"
        setup_messages:
          - "שלום"
          - "דוד נהג"
          - "תל אביב"
          - "2"  # Driver
          - "1"
          - "ירושלים"  # Same destination
          - "כל יום"
          - "08:30"  # Slightly different time
          - "17:30"
          - "2"
          - "3"
          - "1"
        wait_after: 0
        
      - user_id: "hitchhiker_002"
        phone: "0505555555"
        type: "hitchhiker"
        setup_messages:
          - "היי"
          - "שרה טרמפיסטית"
          - "רעננה"
          - "1"  # Hitchhiker
          - "2"
          - "2"
        wait_after: 0
        
      - user_id: "hitchhiker_002"
        phone: "0505555555"
        type: "hitchhiker"
        action_messages:
          - "שלום"
          - "1"  # Looking for ride
          - "1"  # Now
          - "ירושלים"  # Same destination
        wait_after: 0
        
      - user_id: "driver_002a"
        phone: "0503333333"
        type: "driver"
        action_messages:
          - "1"  # First driver approves
        wait_after: 0
        
      - user_id: "driver_002b"
        phone: "0504444444"
        type: "driver"
        action_messages:
          - "1"  # Second driver approves
        wait_after: 0

  # Scenario 3: Driver rejects match
  - id: 3
    name: "Driver Rejects Match"
    description: "Driver receives match notification and rejects it"
    users:
      - user_id: "driver_003"
        phone: "0506666666"
        type: "driver"
        setup_messages:
          - "היי"
          - "רותי נהגת"
          - "ירושלים"
          - "2"  # Driver
          - "1"
          - "תל אביב"
          - "א-ה"
          - "14:00"
          - "20:00"
          - "2"
          - "3"
          - "2"  # Share name preference: ask
        wait_after: 0
        
      - user_id: "hitchhiker_003"
        phone: "0507777777"
        type: "hitchhiker"
        setup_messages:
          - "שלום"
          - "מיכל טרמפיסטית"
          - "רמת גן"
          - "1"  # Hitchhiker
          - "2"
          - "2"
        wait_after: 0
        
      - user_id: "hitchhiker_003"
        phone: "0507777777"
        type: "hitchhiker"
        action_messages:
          - "שלום"
          - "1"
          - "1"
          - "תל אביב"
        wait_after: 0
        
      - user_id: "driver_003"
        phone: "0506666666"
        type: "driver"
        action_messages:
          - "2"  # Reject match
        wait_after: 0

  # Scenario 4: Driver with "ask" preference - name sharing flow
  - id: 4
    name: "Name Sharing Flow - Ask Preference"
    description: "Driver with 'ask' preference gets prompted before sharing name"
    users:
      - user_id: "driver_004"
        phone: "0508888888"
        type: "driver"
        setup_messages:
          - "היי"
          - "יוסי נהג"
          - "חיפה"
          - "2"  # Driver
          - "1"
          - "תל אביב"
          - "א-ה"
          - "07:00"
          - "18:00"
          - "2"
          - "3"
          - "2"  # Share name preference: ask
        wait_after: 0
        
      - user_id: "hitchhiker_004"
        phone: "0509999999"
        type: "hitchhiker"
        setup_messages:
          - "שלום"
          - "דני טרמפיסט"
          - "תל אביב"
          - "1"  # Hitchhiker
          - "2"
          - "2"
        wait_after: 0
        
      - user_id: "hitchhiker_004"
        phone: "0509999999"
        type: "hitchhiker"
        action_messages:
          - "שלום"
          - "1"
          - "1"
          - "תל אביב"
        wait_after: 0
        
      - user_id: "driver_004"
        phone: "0508888888"
        type: "driver"
        action_messages:
          - "1"  # Approve match
          - "share_name_yes_MATCH_"  # Approve name sharing
        wait_after: 0

  # ============================================================================
  # TIME RANGE SCENARIOS (With frozen time)
  # ============================================================================
  
  # Scenario 5: Time-based matching - hitchhiker searches within routine time range
  - id: 5
    name: "Time Range Matching - Within Window"
    description: "Driver creates routine at 07:00, hitchhiker searches at 07:15 (within routine window 06:30-07:30), should match"
    frozen_time: "2025-11-22 06:00:00"
    should_match: true
    expected_matches: 1
    users:
      - user_id: "driver_005"
        phone: "0501111111"
        type: "driver"
        setup_messages:
          - message: "היי"
            frozen_time: "2025-11-22 06:00:00"
          - message: "יוסי נהג"
            frozen_time: "2025-11-22 06:01:00"
          - message: "חיפה"
            frozen_time: "2025-11-22 06:02:00"
          - message: "2"  # Driver
            frozen_time: "2025-11-22 06:03:00"
          - message: "1"
            frozen_time: "2025-11-22 06:04:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 06:05:00"
          - message: "כל יום"
            frozen_time: "2025-11-22 06:06:00"
          - message: "07:00"  # Departure time
            frozen_time: "2025-11-22 07:00:00"  # Routine created at 07:00
          - message: "18:00"
            frozen_time: "2025-11-22 07:01:00"
          - message: "2"
            frozen_time: "2025-11-22 07:02:00"
          - message: "3"
            frozen_time: "2025-11-22 07:03:00"
          - message: "1"
            frozen_time: "2025-11-22 07:04:00"
        time_advance: 0
        
      - user_id: "hitchhiker_005"
        phone: "0502222222"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 07:10:00"
          - message: "דני טרמפיסט"
            frozen_time: "2025-11-22 07:11:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 07:12:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 07:13:00"
          - message: "2"
            frozen_time: "2025-11-22 07:14:00"
          - message: "2"
            frozen_time: "2025-11-22 07:14:30"
        time_advance: 0
        
      - user_id: "hitchhiker_005"
        phone: "0502222222"
        type: "hitchhiker"
        action_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 07:15:00"  # Searches at 07:15, within routine window (06:30-07:30)
          - message: "1"
            frozen_time: "2025-11-22 07:15:30"
          - message: "1"
            frozen_time: "2025-11-22 07:16:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 07:16:30"
        time_advance: 0

  # Scenario 6: Time-based matching - hitchhiker searches too late
  - id: 6
    name: "Time Range Matching - Outside Window"
    description: "Driver creates routine at 07:00, hitchhiker searches at 08:00 (outside routine window), should NOT match"
    frozen_time: "2025-11-22 06:30:00"
    should_match: false
    expected_matches: 0
    users:
      - user_id: "driver_006"
        phone: "0503333333"
        type: "driver"
        setup_messages:
          - message: "היי"
            frozen_time: "2025-11-22 06:30:00"
          - message: "רותי נהגת"
            frozen_time: "2025-11-22 06:31:00"
          - message: "חיפה"
            frozen_time: "2025-11-22 06:32:00"
          - message: "2"  # Driver
            frozen_time: "2025-11-22 06:33:00"
          - message: "1"
            frozen_time: "2025-11-22 06:34:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 06:35:00"
          - message: "כל יום"
            frozen_time: "2025-11-22 06:36:00"
          - message: "07:00"
            frozen_time: "2025-11-22 07:00:00"
          - message: "18:00"
            frozen_time: "2025-11-22 07:01:00"
          - message: "2"
            frozen_time: "2025-11-22 07:02:00"
          - message: "3"
            frozen_time: "2025-11-22 07:03:00"
          - message: "1"
            frozen_time: "2025-11-22 07:04:00"
        time_advance: 0
        
      - user_id: "hitchhiker_006"
        phone: "0504444444"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 07:45:00"
          - message: "מיכל טרמפיסטית"
            frozen_time: "2025-11-22 07:46:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 07:47:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 07:48:00"
          - message: "2"
            frozen_time: "2025-11-22 07:49:00"
          - message: "2"
            frozen_time: "2025-11-22 07:50:00"
        time_advance: 0
        
      - user_id: "hitchhiker_006"
        phone: "0504444444"
        type: "hitchhiker"
        action_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 08:00:00"  # Searches at 08:00, routine window ended at 07:30
          - message: "1"
            frozen_time: "2025-11-22 08:00:30"
          - message: "1"
            frozen_time: "2025-11-22 08:01:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 08:01:30"
        time_advance: 0

  # Scenario 7: Complex multi-user scenario with time progression
  # Note: This scenario tests the flow but may not find matches due to time ranges
  # The main purpose is to test multi-user interactions
  - id: 7
    name: "Complex Multi-User Scenario"
    description: "Multiple hitchhikers register first, then drivers register later, tests complex interactions"
    frozen_time: "2025-11-22 20:00:00"
    should_match: false  # Changed to false - time ranges don't overlap (evening requests vs morning routines)
    expected_matches: 0
    users:
      - user_id: "hitchhiker_007a"
        phone: "0571111111"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 20:00:00"
          - message: "רונן טרמפיסט"
            frozen_time: "2025-11-22 20:01:00"
          - message: "רמת גן"
            frozen_time: "2025-11-22 20:02:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 20:03:00"
          - message: "1"  # Looking now
            frozen_time: "2025-11-22 20:04:00"
          - message: "1"  # Now
            frozen_time: "2025-11-22 20:05:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 20:06:00"
        time_advance: 0
        
      - user_id: "hitchhiker_007b"
        phone: "0572222222"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 20:10:00"
          - message: "שירה טרמפיסטית"
            frozen_time: "2025-11-22 20:11:00"
          - message: "רמת גן"
            frozen_time: "2025-11-22 20:12:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 20:13:00"
          - message: "1"
            frozen_time: "2025-11-22 20:14:00"
          - message: "3"  # In one hour
            frozen_time: "2025-11-22 20:15:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 20:16:00"
        time_advance: 0
        
      - user_id: "hitchhiker_007c"
        phone: "0573333333"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 20:20:00"
          - message: "אור טרמפיסט"
            frozen_time: "2025-11-22 20:21:00"
          - message: "רמת גן"
            frozen_time: "2025-11-22 20:22:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 20:23:00"
          - message: "1"
            frozen_time: "2025-11-22 20:24:00"
          - message: "3"  # In one hour
            frozen_time: "2025-11-22 20:25:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 20:26:00"
        time_advance: 0
        
      - user_id: "driver_007a"
        phone: "0574444444"
        type: "driver"
        setup_messages:
          - message: "היי"
            frozen_time: "2025-11-22 20:30:00"
          - message: "דוד נהג"
            frozen_time: "2025-11-22 20:31:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 20:32:00"
          - message: "2"  # Driver
            frozen_time: "2025-11-22 20:33:00"
          - message: "1"
            frozen_time: "2025-11-22 20:34:00"
          - message: "תל אביב"
            frozen_time: "2025-11-22 20:35:00"
          - message: "כל יום"
            frozen_time: "2025-11-22 20:36:00"
          - message: "07:00"
            frozen_time: "2025-11-22 20:37:00"
          - message: "18:00"
            frozen_time: "2025-11-22 20:38:00"
          - message: "2"
            frozen_time: "2025-11-22 20:39:00"
          - message: "3"
            frozen_time: "2025-11-22 20:40:00"
          - message: "2"  # Share name preference: ask
            frozen_time: "2025-11-22 20:41:00"
        time_advance: 0
        
      - user_id: "driver_007b"
        phone: "0575555555"
        type: "driver"
        setup_messages:
          - message: "היי"
            frozen_time: "2025-11-22 20:45:00"
          - message: "מיכל נהגת"
            frozen_time: "2025-11-22 20:46:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 20:47:00"
          - message: "2"  # Driver
            frozen_time: "2025-11-22 20:48:00"
          - message: "1"
            frozen_time: "2025-11-22 20:49:00"
          - message: "ירושלים"
            frozen_time: "2025-11-22 20:50:00"
          - message: "כל יום"
            frozen_time: "2025-11-22 20:51:00"
          - message: "08:00"
            frozen_time: "2025-11-22 20:52:00"
          - message: "19:00"
            frozen_time: "2025-11-22 20:53:00"
          - message: "2"
            frozen_time: "2025-11-22 20:54:00"
          - message: "3"
            frozen_time: "2025-11-22 20:55:00"
          - message: "1"  # Share name preference: always
            frozen_time: "2025-11-22 20:56:00"
        time_advance: 0

  # Scenario 8: Driver registers AFTER hitchhiker - should find match
  # This tests the fix where driver registration triggers matching with existing hitchhiker requests
  - id: 8
    name: "Driver Registers After Hitchhiker"
    description: "Hitchhiker requests ride first, then driver registers with matching routine - should find match and send notifications"
    frozen_time: "2025-11-22 07:00:00"  # Morning - matching time
    should_match: true
    expected_matches: 1
    users:
      - user_id: "hitchhiker_008"
        phone: "0576666666"
        type: "hitchhiker"
        setup_messages:
          - message: "שלום"
            frozen_time: "2025-11-22 07:00:00"
          - message: "תומר טרמפיסט"
            frozen_time: "2025-11-22 07:01:00"
          - message: "רמת גן"
            frozen_time: "2025-11-22 07:02:00"
          - message: "1"  # Hitchhiker
            frozen_time: "2025-11-22 07:03:00"
          - message: "1"  # Looking now
            frozen_time: "2025-11-22 07:04:00"
          - message: "1"  # Now (ממש עכשיו)
            frozen_time: "2025-11-22 07:05:00"
          - message: "חיפה"
            frozen_time: "2025-11-22 07:06:00"
        time_advance: 0
        
      - user_id: "driver_008"
        phone: "0577777777"
        type: "driver"
        setup_messages:
          - message: "היי"
            frozen_time: "2025-11-22 07:10:00"  # Driver registers AFTER hitchhiker
          - message: "רונית נהגת"
            frozen_time: "2025-11-22 07:11:00"
          - message: "חיפה"
            frozen_time: "2025-11-22 07:12:00"
          - message: "2"  # Driver
            frozen_time: "2025-11-22 07:13:00"
          - message: "1"  # Has routine
            frozen_time: "2025-11-22 07:14:00"
          - message: "חיפה"  # Same destination as hitchhiker
            frozen_time: "2025-11-22 07:15:00"
          - message: "כל יום"
            frozen_time: "2025-11-22 07:16:00"
          - message: "07:00"  # Departure time - matches hitchhiker's request time (07:05-07:35)
            frozen_time: "2025-11-22 07:17:00"
          - message: "18:00"
            frozen_time: "2025-11-22 07:18:00"
          - message: "2"  # No more destinations
            frozen_time: "2025-11-22 07:19:00"
          - message: "3"  # Alert preference: יעדים + שעות
            frozen_time: "2025-11-22 07:20:00"
          - message: "1"  # Share name preference: always (auto-approve)
            frozen_time: "2025-11-22 07:21:00"
        time_advance: 0

