# מדריך לאימות קלט משתמשים

## סקירה כללית

הבוט כעת כולל מנגנון אימות מתקדם שבודק את הקלט שהמשתמש מכניס ומוודא שהוא תקין.

## מה מאומת?

### 1. 🏘️ שמות ישובים

**מתי?** כאשר המשתמש מכניס:
- ישוב מגורים
- יעד נסיעה
- יעד קבוע של שגרה
- יעד מועדף

**איך זה עובד?**
1. הבוט בודק אם הישוב קיים ברשימת הישובים בישראל
2. אם הישוב קיים - שומר אותו (עם נרמול)
3. אם לא קיים - מציע 3 ישובים דומים
4. המשתמש יכול לכתוב שוב או לבחור מההצעות

**דוגמה:**
```
משתמש: תל אבב
בוט: הישוב "תל אבב" לא נמצא במערכת. 🤔

💡 התכוונת ל:
1. תל אביב
2. תל מונד
3. באר שבע

אנא בחר מספר או כתוב שוב.
```

**רשימת ישובים:**
- כל הערים המרכזיות בישראל (100+ ערים)
- אזורים גיאוגרפיים (צפון, דרום, מרכז, גוש דן...)
- קיבוצים ומושבים מרכזיים
- תומך בכתיב עם מקפים ובלי (כפר-סבא / כפר סבא)

### 2. 📅 ימי שבוע

**מתי?** כאשר המשתמש מכניס ימי נסיעה בשגרה

**פורמטים תקינים:**
- `א-ה` (ראשון עד חמישי)
- `א,ג,ה` (ימים ספציפיים בפסיקים)
- `כל יום`
- `כל הימים`
- `יומי`
- `ראשון ושלישי`
- גם באנגלית: `Sunday, Monday`

**דוגמה לשגיאה:**
```
משתמש: יום ראשון עד יום חמישי
בוט: פורמט לא תקין! 😅

דוגמאות נכונות:
• א-ה (ראשון עד חמישי)
• א,ג,ה (ימים ספציפיים)
• כל יום
• ראשון ושלישי

נסה שוב! 😊
```

### 3. ⏰ שעות

**מתי?** כאשר המשתמש מכניס שעת יציאה או חזרה

**פורמט תקין:**
- `HH:MM` (שעה:דקות)
- `07:00`, `14:30`, `08:00`
- גם `7:00` עובד (נרמול אוטומטי ל-`07:00`)

**בדיקות:**
- שעה: 0-23
- דקות: 0-59

**דוגמה לשגיאה:**
```
משתמש: 8
בוט: פורמט שעה לא תקין! ⏰

דוגמאות נכונות:
• 08:00
• 14:30
• 7:00 (זה גם בסדר!)

נסה שוב! 😊
```

### 4. ⏰ טווח שעות

**מתי?** כאשר המשתמש מכניס טווח שעות לנסיעה

**פורמט תקין:**
- `HH:MM-HH:MM` (התחלה-סיום)
- `08:00-10:00`, `14:00-17:00`
- גם `8:00-10:00` עובד

**בדיקות:**
- שתי השעות תקינות
- שעת הסיום אחרי שעת ההתחלה
- נרמול אוטומטי (8:00 → 08:00)

**דוגמה לשגיאה:**
```
משתמש: 10:00-08:00
בוט: שעת הסיום צריכה להיות אחרי שעת ההתחלה! 😅
```

## ארכיטקטורה טכנית

### קבצים חדשים

#### `validation.py`
מודול מרכזי שמכיל:
- `ISRAELI_SETTLEMENTS` - רשימת כל הישובים בישראל
- `SETTLEMENT_VARIATIONS` - וריאציות כתיב (עם/בלי מקפים)
- `validate_settlement()` - אימות ישובים
- `validate_days()` - אימות ימים
- `validate_time()` - אימות שעות בודדות
- `validate_time_range()` - אימות טווח שעות
- `similarity()` - חישוב דמיון בין מחרוזות (Levenshtein)

### שינויים בקבצים קיימים

#### `conversation_engine.py`
- **ייבוא חדש:** `from validation import validate_settlement, validate_days, validate_time, validate_time_range`
- **פונקציה חדשה:** `_validate_input()` - מנתחת את state_id ומחליטה איזה אימות לבצע
- **עדכון:** `_handle_text_input()` - כעת מבצעת אימות לפני שמירת הנתונים

#### `conversation_flow.json`
- **שינוי:** מצב `idle` לא מציג הודעה (תיקון הודעה כפולה)

## זרימת האימות

```
המשתמש מכניס טקסט
        ↓
conversation_engine._handle_text_input()
        ↓
בדיקה: באיזה state המשתמש?
        ↓
קריאה ל-_validate_input(state_id, user_input)
        ↓
    ┌───┴───┐
 תקין    לא תקין
    ↓        ↓
נרמול   הודעת שגיאה
ושמירה   + הצעות
    ↓        ↓
מעבר    שהייה
למצב    באותו
הבא     מצב
```

## דוגמאות שימוש

### דוגמה 1: ישוב תקין
```
User: תל אביב
Bot: נחמד להכיר! 😊
     ועכשיו ספר לי - באיזה ישוב אתה גר? 🏡

User: תל אביב
[נשמר: "תל אביב-יפו"]
Bot: מעולה! 🎉
```

### דוגמה 2: ישוב לא מוכר
```
User: באיזה ישוב אתה גר?
Bot: הישוב "תל אביבב" לא נמצא במערכת. 🤔

💡 התכוונת ל:
1. תל אביב
2. תל מונד
3. גבעת שמואל

אנא בחר מספר או כתוב שוב.

User: 1
[נשמר: "תל אביב-יפו"]
Bot: מעולה! 🎉
```

### דוגמה 3: שעה לא תקינה
```
User: באיזו שעה אתה יוצא?
Bot: אוקיי! ⏰

User: 8
Bot: פורמט שעה לא תקין! ⏰

דוגמאות נכונות:
• 08:00
• 14:30
• 7:00 (זה גם בסדר!)

נסה שוב! 😊

User: 08:00
[נשמר: "08:00"]
Bot: מעולה! 🔄
```

### דוגמה 4: ימים לא תקינים
```
User: באיזה ימים אתה נוסע?
Bot: נחמד! 📅

User: ראשון חמישי
Bot: פורמט לא תקין! 😅

דוגמאות נכונות:
• א-ה (ראשון עד חמישי)
• א,ג,ה (ימים ספציפיים)
• כל יום
• ראשון ושלישי

נסה שוב! 😊

User: א,ה
[נשמר: "א,ה"]
Bot: אוקיי! ⏰
```

## הוספת ישובים נוספים

אם צריך להוסיף ישובים נוספים, פתח את `validation.py` ועדכן את `ISRAELI_SETTLEMENTS`:

```python
ISRAELI_SETTLEMENTS = {
    # ... existing settlements ...
    'הישוב החדש',
    'עוד ישוב',
}
```

המערכת תוסיף אוטומטית וריאציות (עם/בלי מקפים, case-insensitive).

## בדיקות

הוסף את הבדיקות הבאות ל-`test_conversation_flow.py`:

```python
def test_settlement_validation(self):
    """Test settlement validation"""
    # Valid settlement
    response, buttons = self.send_message("תל אביב", 1)
    self.verify_user_data("home_settlement", "תל אביב-יפו", 1)
    
    # Invalid settlement
    response, buttons = self.send_message("תל אבבבב", 1, "לא נמצא במערכת")
    
    # Should suggest similar settlements
    self.assertIn("התכוונת ל", response)
```

## יתרונות

1. ✅ **UX טוב יותר** - המשתמש מקבל משוב מיידי על שגיאות
2. ✅ **נתונים נקיים** - המערכת שומרת נתונים נורמלים ותקינים
3. ✅ **פחות באגים** - מניעת שמירת נתונים לא תקינים
4. ✅ **הצעות חכמות** - המערכת מציעה תיקונים אוטומטיים
5. ✅ **גמישות** - תומך בכתיבים שונים של אותו ישוב

## מגבלות נוכחיות

- רשימת הישובים סטטית (לא מתעדכנת אוטומטית)
- אין אימות לשדות אחרים (שם, תאריך)
- אין תמיכה באנגלית לשמות ישובים

## שיפורים עתידיים

1. 🔮 אימות תאריכים ושעות בפורמטים נוספים
2. 🔮 אינטגרציה עם API של מיקודים/ישובים
3. 🔮 תמיכה בשמות ישובים באנגלית
4. 🔮 למידת מכונה - שיפור ההצעות לפי שימוש
5. 🔮 אימות שמות (בדיקת אותיות עבריות בלבד)

---

**סטטוס:** ✅ פעיל ועובד  
**גרסה:** 1.0  
**עדכון אחרון:** נובמבר 2025

