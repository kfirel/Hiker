# מדריך בדיקה - מערכת ניתוב חכמה

## סקירה כללית

המערכת החדשה מזהה אם ישוב נמצא על הדרך בין שתי נקודות, עם סף דינמי שמתאים את עצמו לאורך המסלול.

## 🧪 1. בדיקה אוטומטית (מומלץ להתחיל כאן)

הרץ את סקריפט הבדיקה המקיף:

```bash
python test_route_system.py
```

הסקריפט בודק:
- ✅ Geocoding (המרת כתובות לקואורדינטות)
- ✅ חישוב סף דינמי
- ✅ חישוב מסלולים מ-OSRM
- ✅ חישוב מרחקים (Haversine)
- ✅ תרחיש התאמה מציאותי
- ✅ Edge cases

**פלט מצופה:**
```
✅ All tests passed! 🎉
```

---

## 🤖 2. בדיקה ידנית דרך WhatsApp

### תרחיש 1: נהג יוצר נסיעה (Background Calculation)

**שלב 1:** נהג יוצר נסיעה
```
אני נוסע לאשקלון מחר בשעה 8
```

**תוצאה מצופה:**
- ✅ תגובה מיידית (תוך שניה): "הנסיעה נשמרה! 🚗"
- 🔄 ברקע: המסלול מחושב ונשמר (2-3 שניות)

**בדיקה בלוגים:**
```bash
# בטרמינל נפרד, עקוב אחרי הלוגים:
tail -f /path/to/logs/app.log | grep -E "(Route|OSRM|Background)"
```

**לוגים מצופים:**
```
🔄 Background route calc (attempt 1/3): גברעם → אשקלון
🔍 Querying OSRM: גברעם → אשקלון
✅ Route calculated: 25.3km, threshold: 5.03km, 156 points
✅ Route saved in background for {ride_id}: 25.3km
```

---

### תרחיש 2: טרמפיסט מחפש (מיד לאחר שהנהג יצר)

**שלב 2a:** טרמפיסט מחפש תוך שניות (לפני שהמסלול מוכן)
```
מחפש טרמפ לניר-עם מחר בשעה 8
```

**תוצאה מצופה:**
- ⏳ המערכת רואה `route_calculation_pending=True`
- 🔍 מדלגת על בדיקת "על הדרך" (לעת עתה)
- ✅ התאמה ישירה בלבד (אם יעדים זהים)

**לוגים מצופים:**
```
⏳ Route calculation still in progress, skipping on-route check
```

---

**שלב 2b:** טרמפיסט מחפש שוב אחרי 5 שניות
```
מחפש טרמפ לניר-עם מחר בשעה 8
```

**תוצאה מצופה:**
- ✅ המסלול כבר מוכן ב-DB
- 📏 חישוב מרחק: ניר-עם נמצא ~2.8 ק"מ מהמסלול
- ✅ התאמה! (2.8 < 5.03)
- 📱 שני ההודעות מקבלים הודעת התאמה

**הודעת התאמה לטרמפיסט:**
```
🚗 נמצא נהג!

[שם נהג] נוסע לאשקלון
תאריך: 2026-01-03
שעה: 08:00

📍 היעד שלך נמצא בדרך (2.8 ק"מ מהמסלול)

📱 טלפון: +972...
```

**הודעת התאמה לנהג:**
```
🎒 נמצא טרמפיסט!

[שם טרמפיסט] מחפש/ת נסיעה לניר-עם
תאריך: 2026-01-03
שעה: 08:00

📍 היעד שלו/ה בדרך אליך (2.8 ק"מ מהמסלול שלך)

📱 טלפון: +972...
```

---

### תרחיש 3: נהג מעדכן יעד (Re-calculation)

**שלב 3:** נהג מעדכן את היעד
```
עדכן נסיעה 1 ליעד באר שבע
```

**תוצאה מצופה:**
- ✅ תגובה מיידית: "עודכן! ✅"
- 🔄 ברקע: חישוב מסלול חדש (גברעם → באר שבע)
- 🚫 Task ישן מבוטל אם עדיין רץ

**לוגים מצופים:**
```
🔄 Recalculating route in background for {ride_id}
🚫 Cancelled old route calculation for {ride_id}  [אם היה task קודם]
✅ Route saved in background for {ride_id}: 85.4km
```

---

### תרחיש 4: Lazy Loading (נסיעה ישנה ללא מסלול)

אם יש נסיעות ישנות (מלפני ה-update) שאין להן `route_coordinates`:

**תוצאה מצופה:**
- 💤 במציאת התאמה: "Lazy loading route for..."
- 🔍 חישוב מסלול על המקום
- 💾 שמירה ב-DB לפעם הבאה

**לוגים מצופים:**
```
💤 Lazy loading route for גברעם → תל אביב
🔍 Querying OSRM: גברעם → תל אביב
✅ Updated route data for ride {ride_id}: 95.2km
```

---

## 📊 3. בדיקת Database (Firestore)

בדוק ש-driver rides מכילים את השדות החדשים:

```python
# פייתון console או script
from database import get_user_rides_and_requests

data = await get_user_rides_and_requests("+972...")
driver_ride = data["driver_rides"][0]

print(driver_ride)
```

**שדות מצופים:**
```python
{
    "id": "uuid...",
    "origin": "גברעם",
    "destination": "אשקלון",
    "route_coordinates": [[31.234, 34.567], [31.245, 34.578], ...],  # מערך
    "route_distance_km": 25.3,
    "route_threshold_km": 5.03,
    "route_calculation_pending": False,  # False אחרי שהחישוב הסתיים
    # ... שאר השדות הקיימים
}
```

---

## 🔍 4. בדיקת תרחישים ספציפיים

### תרחיש A: מסלול קצר (דיוק גבוה)

```
נהג: אני נוסע לקיבוץ זיקים מחר ב-8  (10 ק"מ)
טרמפיסט: מחפש טרמפ לצומת רעים מחר ב-8  (1.5 ק"מ מהמסלול)
```

**מצופה:** ✅ התאמה (סף: ~3 ק"מ, 1.5 < 3)

---

### תרחיש B: מסלול ארוך (סלחנות גבוהה)

```
נהג: אני נוסע לירושלים מחר ב-8  (80 ק"מ)
טרמפיסט: מחפש טרמפ לבית שמש מחר ב-8  (6 ק"מ מהמסלול)
```

**מצופה:** ✅ התאמה (סף: 10 ק"מ, 6 < 10)

---

### תרחיש C: יעד רחוק מדי

```
נהג: אני נוסע לאשקלון מחר ב-8  (25 ק"מ)
טרמפיסט: מחפש טרמפ לבאר שבע מחר ב-8  (50 ק"מ מהמסלול)
```

**מצופה:** ❌ אין התאמה (סף: ~5 ק"מ, 50 > 5)

---

### תרחיש D: Retry Logic

כדי לבדוק retry (קשה בלי לנתק רשת), בדוק את הלוגים:

**סימולציה:** כבה זמנית את האינטרנט לשרת בזמן שנהג יוצר נסיעה

**לוגים מצופים:**
```
⚠️ Background route calc failed (attempt 1/3): ...
[המתנה 2 שניות]
⚠️ Background route calc failed (attempt 2/3): ...
[המתנה 2 שניות]
⚠️ Background route calc failed (attempt 3/3): ...
❌ All retry attempts failed for {ride_id}. Will use lazy loading.
```

---

## 🎯 5. בדיקת ביצועים

### זמן תגובה למשתמש

```bash
# מדוד זמן תגובה
time curl -X POST https://your-api/webhook \
  -H "Content-Type: application/json" \
  -d '{"message": "אני נוסע לאשקלון מחר ב-8"}'
```

**מצופה:** < 500ms (ללא חישוב מסלול, שזה ברקע)

---

### זמן חישוב מסלול (ברקע)

עקוב אחרי הלוגים:
```bash
grep "Route saved in background" logs.txt
```

**מצופה:** 2-5 שניות (תלוי ב-OSRM ובאורך המסלול)

---

## ⚠️ 6. בעיות נפוצות ופתרונות

### בעיה 1: "Failed to geocode"

**סיבה:** Nominatim לא מצא את הכתובת

**פתרון:** 
- בדוק איות של שמות מקומות
- נסה שמות אלטרנטיביים (למשל "באר שבע" במקום "באר-שבע")

---

### בעיה 2: "OSRM returned no route"

**סיבה:** OSRM לא מצא מסלול כבישים

**פתרון:**
- בדוק שהנקודות בישראל
- נסה נקודות קרובות יותר לערים מרכזיות

---

### בעיה 3: Route calculation תקוע על "pending"

**סיבה:** Background task נכשל בשקט

**פתרון:**
- בדוק logs לשגיאות
- הרץ ידנית: `await get_route_data("גברעם", "אשקלון")`
- בדוק חיבור אינטרנט לשרת

---

### בעיה 4: Lazy loading לוקח יותר מדי זמן

**סיבה:** מחשב מסלול בזמן חיפוש התאמות

**פתרון:**
- זה מצופה לנסיעות ישנות
- הפעם השניה יהיה מהיר (המסלול שמור)
- אפשר להריץ migration script לנסיעות קיימות

---

## 📈 7. מטריקות הצלחה

מה לבדוק:

✅ **תגובה מיידית:** < 500ms תמיד

✅ **חישוב מסלול:** 2-5 שניות ברקע

✅ **התאמות חדשות:** נהג לאילת + טרמפיסט לבאר שבע על הדרך = מתאים!

✅ **אין שגיאות:** 0 crashes, graceful fallbacks

✅ **סף דינמי עובד:** מסלול 10 ק"מ → סף 3.5, מסלול 100 ק"מ → סף 10

---

## 🔧 8. כלים נוספים

### בדיקה ידנית של פונקציות

```python
# Python console
from services.route_service import *

# Test geocoding
coords = geocode_address("תל אביב")
print(coords)

# Test route
route = await get_route_data("גברעם", "אשקלון")
print(f"Distance: {route['distance_km']:.1f}km")
print(f"Threshold: {route['threshold_km']:.1f}km")

# Test distance
hitchhiker_coords = geocode_address("ניר-עם")
min_dist = calculate_min_distance_to_route(route['coordinates'], hitchhiker_coords)
print(f"Min distance: {min_dist:.1f}km")
```

---

## ✅ Checklist סיכום

לפני production:

- [ ] כל הטסטים ב-`test_route_system.py` עוברים
- [ ] תגובה מיידית למשתמש (< 500ms)
- [ ] חישוב מסלול ברקע עובד
- [ ] Retry logic עובד (בדוק logs)
- [ ] Lazy loading עובד
- [ ] התאמות "על הדרך" עובדות
- [ ] הודעות מכילות מרחק מהמסלול
- [ ] Race conditions מטופלים (עדכון מהיר)
- [ ] Logs ברורים ומסודרים
- [ ] אין memory leaks (task tracking עובד)

---

## 🎉 סיכום

המערכת מאפשרת:
1. 🚗 נהג יוצר נסיעה → תגובה מיידית
2. 🔄 מסלול מחושב ברקע (2-3 שניות)
3. 🎒 טרמפיסט מחפש → מוצא נהגים גם אם היעדים לא זהים!
4. 📍 הודעות ברורות: "היעד שלך 2.8 ק"מ מהמסלול"
5. 🎯 סף דינמי - מסלולים קצרים דורשים דיוק גבוה

בהצלחה! 🚀

